// Unikeybord / Diverge TM2
// ,-------------------------------------------------------------------------.    ,-----------------------------------------------------------------------.
//    _______,    _______,    _______,    _______,    _______,    _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
//    _______,    _______,    _______,    _______,    _______,    _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
//    _______,    _______,    _______,    _______,    _______,    _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
//    _______,    _______,    _______,    _______,          _______,                       _______,          _______,    _______,    _______,    _______
// `-----------+-----------+-----------+-----------+-------------------------'    `-----------------------+-----------+-----------+-----------+-----------'

#include QMK_KEYBOARD_H

enum layer_names {
  COLEMAK,
  NAV,     // Navigation
  NUM,     // Numbers
  MOU,   // Mouse layer
  SYM,    // Alternative access to symbols
  MED,     // Punctuation
  FUN,     // Function keys
  LHC,     // Left hand only CHARs
  LHN,     // Left hand only NAV
};

// custom key to toggle NUM layer for switch statement
enum custom_keycodes {
  T_NUM = SAFE_RANGE
};

// mode tap keys
// RIGHT
#define HM_A LALT_T(KC_A)
#define HM_R LSFT_T(KC_R)
#define HM_S LCTL_T(KC_S)
#define HM_T LGUI_T(KC_T)

#define HM_Z LT(LHN,KC_Z)

// LEFT
#define HM_N RGUI_T(KC_N)
#define HM_E RCTL_T(KC_E)
#define HM_I RSFT_T(KC_I)
#define HM_O RALT_T(KC_O)

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

[COLEMAK] = LAYOUT_ortho_4x12_2x2u(
// ,-------------------------------------------------------------------------.    ,-----------------------------------------------------------------------.
       KC_Q,       KC_W,       KC_F,       KC_P,       KC_B,      XXXXXXX,           XXXXXXX,     KC_J,       KC_L,       KC_U,       KC_Y,      XXXXXXX,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
       HM_A,       HM_R,       HM_S,       HM_T,       KC_G,      XXXXXXX,           XXXXXXX,     KC_K,       HM_N,       HM_E,       HM_I,       HM_O,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
       HM_Z,       KC_X,       KC_C,       KC_D,       KC_V,      XXXXXXX,           XXXXXXX,     KC_M,       KC_H,      KC_COMM,    KC_DOT,     KC_SLSH,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      XXXXXXX,  XXXXXXX, LT(LHC,KC_ESC), LT(NAV,KC_SPC), LT(MOU,KC_TAB),             LT(SYM,KC_ENT),  LT(NUM,KC_BSPC),LT(FUN,KC_DEL), XXXXXXX,  XXXXXXX
// `-----------+-----------+-----------+-----------+-------------------------'    `-----------------------+-----------+-----------+-----------+-----------'
),

// Main Navigation
[NAV] = LAYOUT_ortho_4x12_2x2u(
// ,-------------------------------------------------------------------------.    ,-----------------------------------------------------------------------.
      _______,    _______,    _______,    _______,    _______,    _______,           _______,    KC_AGIN,    KC_PSTE,    KC_COPY,   KC_CUT,     KC_UNDO,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      KC_LALT,    KC_LSFT,    KC_LCTL,    KC_LGUI,    _______,    _______,           _______,    KC_CAPS,    KC_LEFT,    KC_DOWN,    KC_UP,     KC_RGHT,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      _______,    _______,    _______,    _______,    _______,    _______,           _______,    KC_INS,     KC_HOME,    KC_PGDN,   KC_PGUP,    KC_END,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      _______,    _______,    _______,    _______,          _______,                       _______,          _______,    _______,    _______,    _______
// `-----------+-----------+-----------+-----------+-------------------------'    `-----------------------+-----------+-----------+-----------+-----------'
),

// Numbers and arithmetic
[NUM] = LAYOUT_ortho_4x12_2x2u(
// ,-------------------------------------------------------------------------.    ,-----------------------------------------------------------------------.
      KC_LBRC,     KC_4,        KC_5,       KC_6,     KC_RBRC,     _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      KC_SCLN,     KC_1,        KC_2,       KC_3,     KC_EQL,     _______,           _______,    _______,    KC_RGUI,    KC_RCTL,    KC_RSFT,    KC_RALT,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      KC_GRV,      KC_7,        KC_8,       KC_9,     KC_BSLS,    _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      _______,    _______,     KC_DOT,      KC_0,           KC_MINS,                       _______,          _______,    _______,   _______,     _______
// `-----------+-----------+-----------+-----------+-------------------------'    `-----------------------+-----------+-----------+-----------+-----------'
),

// Placeholder. Currently not mouse
[MOU] = LAYOUT_ortho_4x12_2x2u(
// ,-------------------------------------------------------------------------.    ,-----------------------------------------------------------------------.
      _______,    _______,    _______,    _______,    _______,    _______,           _______,    _______,    _______,    KC_LBRC,    KC_RBRC,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      KC_LALT,    KC_LSFT,    KC_LCTL,    KC_LGUI,    _______,    _______,           _______,    _______,    KC_LPRN,    KC_LCBR,    KC_RCBR,    KC_RPRN,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      _______,    _______,    _______,    _______,    _______,    _______,           _______,    _______,    KC_EQL,     KC_LABK,    KC_RABK,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      _______,    _______,    _______,    _______,          _______,                       _______,          _______,    _______,    _______,    _______
// `-----------+-----------+-----------+-----------+-------------------------'    `-----------------------+-----------+-----------+-----------+-----------'
),

[SYM] = LAYOUT_ortho_4x12_2x2u(
// ,-------------------------------------------------------------------------.    ,-----------------------------------------------------------------------.
      _______,   KC_LBRC,    KC_RBRC,    _______,     _______,    _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |----------+-----------+-----------+------------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      KC_LPRN,   KC_LCBR,    KC_RCBR,    KC_RPRN,     _______,    _______,           _______,    _______,    KC_RGUI,    KC_RCTL,    KC_RSFT,    KC_RALT,
// |----------+-----------+-----------+------------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      _______,   KC_LABK,    KC_RABK,    KC_EQL,      _______,    _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      _______,    _______,    _______,    _______,          _______,                       _______,          _______,    _______,   _______,     _______
// `-----------+-----------+-----------+-----------+-------------------------'    `-----------------------+-----------+-----------+-----------+-----------'
),

// Left hand only: mirror of right hand characters
[MED] = LAYOUT_ortho_4x12_2x2u(
// ,-------------------------------------------------------------------------.    ,-----------------------------------------------------------------------.
      _______,    _______,    _______,    _______,    _______,    _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      KC_LALT,    KC_LSFT,    KC_LCTL,    KC_LGUI,    _______,    _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      _______,    _______,    _______,    _______,    _______,    _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      _______,    _______,    _______,    _______,          _______,                       _______,          _______,    _______,    _______,    _______
// `-----------+-----------+-----------+-----------+-------------------------'    `-----------------------+-----------+-----------+-----------+-----------'
),

[FUN] = LAYOUT_ortho_4x12_2x2u(
// ,-------------------------------------------------------------------------.    ,-----------------------------------------------------------------------.
       KC_F10,    KC_F4,      KC_F5,      KC_F6,      _______,    _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |----------+-----------+-----------+------------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
       KC_F11,    KC_F1,      KC_F2,      KC_F3,      _______,    _______,           _______,    _______,    KC_RGUI,    KC_RCTL,    KC_RSFT,    KC_RALT,
// |----------+-----------+-----------+------------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
       KC_F12,    KC_F7,      KC_F8,      KC_F9,      _______,    _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      _______,    _______,    _______,    _______,          _______,                       _______,          _______,    _______,   _______,     _______
// `-----------+-----------+-----------+-----------+-------------------------'    `-----------------------+-----------+-----------+-----------+-----------'
),

// Left hand only: navigation
[LHN] = LAYOUT_ortho_4x12_2x2u(
// ,-------------------------------------------------------------------------.    ,-----------------------------------------------------------------------.
      _______,    KC_HOME,    KC_UP,      KC_END,     KC_PGUP,    _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      _______,    KC_LEFT,    KC_DOWN,    KC_RGHT,    KC_SPC,     _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      _______,    KC_BSPC,    KC_DEL,     KC_ENT,     KC_PGDN,    _______,           _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-------------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      QK_BOOT,    _______,    _______,    _______,          _______,                       _______,          _______,    _______,    _______,    _______
// `-----------+-----------+-----------+-----------+-------------------------'    `-----------------------+-----------+-----------+-----------+-----------'
),

// Left hand only: mirror of right hand characters
[MED] = LAYOUT_ortho_4x12_2x2u(
// ,-----------------------------------------------------------------------.    ,-----------------------------------------------------------------------.
      _______,     KC_Y,       KC_U,       KC_L,       KC_J,      _______,         _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-----------|    |-----------+-----------+-----------+-----------+-----------+-----------|
       KC_O,       KC_I,       KC_E,       KC_N,       KC_K,      _______,         _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-----------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      KC_COMM,     KC_DOT,    KC_SLSH,     KC_H,       KC_M,      _______,         _______,    _______,    _______,    _______,    _______,    _______,
// |-----------+-----------+-----------+-----------+-----------+-----------|    |-----------+-----------+-----------+-----------+-----------+-----------|
      _______,    _______,    _______,    _______,          _______,                     _______,          _______,    _______,    _______,    _______
// `-----------------------+-----------+-----------+-----------+-----------'    `-----------------------+-----------+-----------+-----------+-----------'
),

};

void toggle_num_layer(void);

void toggle_num_layer() {
  if (IS_LAYER_ON(NUM)) {
    // turn off the layer
    layer_off(NUM);

    // send f18
    SEND_STRING(SS_TAP(X_F18));
  } else {
    // turn layer on
    layer_on(NUM);

    // send f17
    SEND_STRING(SS_TAP(X_F17));
  }
}


// SHIFT + BACKSPACE = DELETE
// Initialize variable holding the binary
// representation of active modifiers.
uint8_t mod_state;
bool process_record_user(uint16_t keycode, keyrecord_t *record) {
    mod_state = get_mods();
    switch (keycode) {

      case T_NUM:
        if (record->event.pressed) toggle_num_layer();

        return false;

    case LT(NUM,KC_BSPC):
        {
        // Initialize a boolean variable that keeps track
        // of the delete key status: registered or not?
        static bool delkey_registered;
        if (record->event.pressed) {
            // Detect the activation of either shift keys
            if (mod_state & MOD_MASK_SHIFT) {
                // First temporarily canceling both shifts so that
                // shift isn't applied to the KC_DEL keycode
                del_mods(MOD_MASK_SHIFT);
                register_code(KC_DEL);
                // Update the boolean variable to reflect the status of KC_DEL
                delkey_registered = true;
                // Reapplying modifier state so that the held shift key(s)
                // still work even after having tapped the Backspace/Delete key.
                set_mods(mod_state);
                return false;
            }
        } else { // on release of KC_BSPC
            // In case KC_DEL is still being sent even after the release of KC_BSPC
            if (delkey_registered) {
                unregister_code(KC_DEL);
                delkey_registered = false;
                return false;
            }
        }
        // Let QMK process the KC_BSPC keycode as usual outside of shift
        return true;
    }

    // Prevent accidental activation of Layer 6
    case HM_N:
        if (record->event.pressed) {
            if (IS_LAYER_ON(4)) {
                tap_code(KC_E);
                tap_code(KC_N);
                return false;
            }
        }
        return true;

    // Prevent accidenal activation of Left Control
    case HM_T:
        if (record->event.pressed) {
            if (IS_LAYER_ON(3)) {
                tap_code(KC_S);
                tap_code(KC_T);
                return false;
            }
        }
        return true;

    case HM_S:
        if (record->event.pressed) {
            // Prevent activation of Layer 1 on outward roll
            if (IS_LAYER_ON(1)) {
                layer_off(1);
                tap_code(KC_T);
                tap_code(KC_S);
                return false;
            }
            // Prevent activaction of Layer 3 on inward roll
            if (IS_LAYER_ON(5)) {
                layer_off(5);
                tap_code(KC_R);
                tap_code(KC_S);
                return false;
            }
        }
        return true;

    // Prevent activation of Layer 2 on outward roll
    case HM_E:
        if (record->event.pressed) {
            if (IS_LAYER_ON(2)) {
                layer_off(2);
                tap_code(KC_N);
                tap_code(KC_E);
                return false;
            }

            // Prevent activaction of Layer 4 on inward roll
            if (IS_LAYER_ON(6)) {
                layer_off(6);
                tap_code(KC_I);
                tap_code(KC_E);
                return false;
            }
        }
        return true;

    // Prevent activaction of Layer 3 on outward roll
    case HM_A:
        if (record->event.pressed) {
            if (IS_LAYER_ON(5)) {
                layer_off(5);
                tap_code(KC_R);
                tap_code(KC_A);
                return false;
            }
        }
        return true;

    // Prevent activaction of Layer 4 on outward roll
    case HM_O:
        if (record->event.pressed) {
            if (IS_LAYER_ON(6)) {
                layer_off(6);
                tap_code(KC_I);
                tap_code(KC_O);
                return false;
            }
        }
        return true;

    case HM_I:
        if (record->event.pressed) {
            // Prevent activaction of Layer 2 on jump from n to i
            if (IS_LAYER_ON(2)) {
                layer_off(2);
                tap_code(KC_N);
                tap_code(KC_I);
                return false;
            }
            // Prevent activaction of Right Control
            if (IS_LAYER_ON(4)) {
                tap_code(KC_E);
                tap_code(KC_I);
                return false;
            }
        }
        return true;

    }
    return true;
};

bool get_custom_auto_shifted_key(uint16_t keycode, keyrecord_t *record) {
  if(IS_RETRO(keycode)) return true;
  return false;
}

//const uint16_t PROGMEM test_combo1[] = {KC_A, KC_B, COMBO_END};
//combo_t key_combos[COMBO_COUNT] = {
//    COMBO(test_combo1, KC_ESC),
//};
